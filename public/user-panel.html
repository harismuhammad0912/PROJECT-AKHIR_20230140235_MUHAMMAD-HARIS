<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Developer Console</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* CSS Tambahan Khusus untuk Tombol Switch View */
        .view-toggle {
            display: flex; gap: 5px; margin-bottom: 10px;
        }
        .btn-tiny {
            padding: 5px 12px; font-size: 10px; border-radius: 4px;
            background: rgba(0,0,0,0.3); border: 1px solid var(--text-muted); color: var(--text-muted);
        }
        .btn-tiny.active {
            border-color: var(--primary); color: var(--bg-deep); background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }
        /* Penyesuaian Tabel di dalam Terminal */
        .terminal-table { width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif; }
        .terminal-table th { text-align: left; color: var(--primary); border-bottom: 1px solid #333; padding: 8px; font-size: 11px; }
        .terminal-table td { padding: 8px; border-bottom: 1px solid #222; color: #ddd; font-size: 12px; }
        .terminal-table tr:hover td { background: rgba(0, 243, 255, 0.1); }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <div class="sidebar">
            <div class="brand">VORTEX<span>DEV</span></div>
            <div class="nav-item active">ðŸ”‘ API Keys</div>
            <div class="nav-item" onclick="alert('Module offline')">ðŸ“„ Documentation</div>
            <div class="nav-item" onclick="alert('Connecting...')">ðŸ’¬ Support</div>
            
            <div style="margin-top: auto;">
                <div class="cyber-card" style="padding: 15px; margin-bottom: 10px;">
                    <small style="color: var(--text-muted);">Logged in as</small><br>
                    <b style="color: var(--primary);" id="displayUsername">...</b>
                </div>
                <button onclick="logout()" class="btn-danger" style="width: 100%;">DISCONNECT</button>
            </div>
        </div>

        <div class="main-content">
            <h2 style="margin-bottom: 30px; font-size: 32px;">ACCESS MANAGEMENT</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px;">
                
                <div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                        <h3 style="color: var(--text-muted);">YOUR KEYS</h3>
                        <button onclick="createKey()" class="btn" style="padding: 8px 16px; font-size: 12px;">+ NEW KEY</button>
                    </div>
                    <div id="keyList" style="display: flex; flex-direction: column; gap: 15px;">
                        </div>
                </div>

                <div class="cyber-card">
                    <h3 style="border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; color: var(--primary);">
                        API TERMINAL
                    </h3>
                    
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="font-size: 11px; color: var(--text-muted); font-weight: bold;">TARGET ENDPOINT</label>
                            <select id="endpoint">
                                <option value="/api/v1/games">GET /games (All Inventory)</option>
                                <option value="/api/v1/games/search">GET /games/search (Filter Query)</option>
                                <option value="/api/v1/games/detail">GET /games/detail/:id (Single Item)</option>
                            </select>
                        </div>

                        <div id="queryBox" style="display: none;">
                            <label style="font-size: 11px; color: var(--text-muted); font-weight: bold;">PARAMETER (Query / ID)</label>
                            <input type="text" id="queryParam" placeholder="...">
                        </div>

                        <div>
                            <label style="font-size: 11px; color: var(--text-muted); font-weight: bold;">AUTHORIZATION (X-API-KEY)</label>
                            <select id="keySelect"></select>
                        </div>

                        <button onclick="sendReq()" class="btn" style="width: 100%;">EXECUTE REQUEST</button>
                    </div>

                    <div style="margin-top: 20px; background: #000; border: 1px solid #333; border-radius: 8px; padding: 15px; min-height: 200px;">
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px;">
                            <span style="color: #666; font-size: 11px;">TERMINAL OUTPUT</span>
                            
                            <div class="view-toggle">
                                <button class="btn btn-tiny active" onclick="switchView('json', this)">JSON</button>
                                <button class="btn btn-tiny" onclick="switchView('table', this)">TABLE</button>
                            </div>
                        </div>

                        <div id="output" style="color: var(--success); white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto;">// Ready for input...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let currentResponse = null; // Menyimpan data hasil fetch terakhir

        window.onload = async () => {
            const auth = await fetch('/auth/me').then(r => r.json());
            if(!auth.loggedIn) window.location.href = '/';
            document.getElementById('displayUsername').innerText = auth.user.username;
            loadKeys();
        };

        async function loadKeys() {
            const keys = await fetch('/api/my-keys').then(r => r.json());
            const list = document.getElementById('keyList');
            const select = document.getElementById('keySelect');
            
            list.innerHTML = '';
            select.innerHTML = '';

            keys.forEach(k => {
                list.innerHTML += `
                    <div class="cyber-card" style="padding: 15px;">
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-weight:bold; color:white;">${k.key_label}</span>
                            <span style="font-size:10px; color:var(--success);">ACTIVE</span>
                        </div>
                        <code style="display:block; margin: 10px 0; color:var(--primary); background:rgba(0,0,0,0.3); padding:5px;">${k.api_key}</code>
                        <div style="text-align:right;">
                            <button onclick="revoke(${k.id})" class="btn-danger" style="padding: 6px 12px; font-size: 10px;">REVOKE ACCESS</button>
                        </div>
                    </div>
                `;
                select.innerHTML += `<option value="${k.api_key}">${k.key_label}</option>`;
            });
        }

        async function createKey() {
            const label = prompt("ENTER PROJECT CODENAME:");
            if(label) { await fetch('/api/create-key', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({label})}); loadKeys(); }
        }

        async function revoke(id) {
            if(confirm('REVOKE KEY? Access will be denied immediately.')) { await fetch(`/api/revoke-key/${id}`, {method:'DELETE'}); loadKeys(); }
        }

        document.getElementById('endpoint').addEventListener('change', function() {
            const val = this.value;
            const box = document.getElementById('queryBox');
            const input = document.getElementById('queryParam');
            
            if (val.includes('search')) {
                box.style.display = 'block';
                input.placeholder = "Search Query (e.g. Elden)";
            } else if (val.includes('detail')) {
                box.style.display = 'block';
                input.placeholder = "Game ID (e.g. 1)";
            } else {
                box.style.display = 'none';
            }
        });

        // === CORE REQUEST LOGIC ===
        async function sendReq() {
            const key = document.getElementById('keySelect').value;
            let url = document.getElementById('endpoint').value;
            const param = document.getElementById('queryParam').value;

            // Logic URL Builder
            if(url.includes('search')) {
                url += "?q=" + encodeURIComponent(param);
            } else if (url.includes('detail')) {
                // Ganti placeholder :id dengan nilai param
                url = url.replace(':id', param);
            }
            
            document.getElementById('output').innerText = "CONNECTING TO VORTEX MAINFRAME...";
            
            try {
                const res = await fetch(url, {headers: {'x-api-key': key}});
                currentResponse = await res.json(); // Simpan ke variable global
                
                // Default tampilkan JSON
                renderJSON();
                // Reset tombol aktif ke JSON
                document.querySelectorAll('.btn-tiny').forEach(b => b.classList.remove('active'));
                document.querySelector('.btn-tiny:first-child').classList.add('active');

            } catch(e) {
                document.getElementById('output').innerText = "CONNECTION FAILED: " + e.message;
            }
        }

        // === LOGIKA DISPLAY (JSON vs TABLE) ===
        function switchView(mode, btn) {
            if(!currentResponse) return;

            // Update tombol aktif
            document.querySelectorAll('.btn-tiny').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if(mode === 'json') renderJSON();
            else renderTable();
        }

        function renderJSON() {
            document.getElementById('output').innerText = JSON.stringify(currentResponse, null, 2);
        }

        function renderTable() {
            const container = document.getElementById('output');
            
            // Cek apakah ada data di dalam response
            // API kita biasanya me-return: { meta: {...}, data: [...] } atau { data: {...} }
            let items = currentResponse.data || currentResponse;

            // Jika item adalah object tunggal (Detail Game), bungkus jadi array
            if (!Array.isArray(items) && typeof items === 'object') {
                items = [items];
            }

            // Jika bukan array (misal error message), tidak bisa jadi tabel
            if (!Array.isArray(items) || items.length === 0) {
                container.innerHTML = '<span style="color:var(--danger)">CANNOT RENDER AS TABLE (Data Empty or Invalid format)</span>';
                return;
            }

            // Buat Tabel
            const headers = Object.keys(items[0]);
            let html = `<table class="terminal-table"><thead><tr>`;
            
            headers.forEach(h => html += `<th>${h.toUpperCase()}</th>`);
            html += `</tr></thead><tbody>`;

            items.forEach(row => {
                html += `<tr>`;
                headers.forEach(h => {
                    let val = row[h];
                    // Format harga jika angka besar
                    if(h === 'price') val = parseInt(val).toLocaleString();
                    html += `<td>${val}</td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;

            container.innerHTML = html;
        }

        function logout() { fetch('/auth/logout').then(()=>window.location.href='/'); }
    </script>
</body>
</html>